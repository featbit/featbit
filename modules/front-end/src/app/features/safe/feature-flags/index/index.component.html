<section class="body-container">
  <div class="table-content-area">
    <div class="table-search-area">
      <div class="search-inputs">
        <nz-input-group style="width: 220px" [nzPrefix]="prefixIconSearch">
          <input nz-input type="text" placeholder="Filter flags by name or key" i18n-placeholder="@@ff.filter-by-name-and-key" [(ngModel)]="featureFlagFilter.name" (ngModelChange)="onSearch(true)">
        </nz-input-group>
        <ng-template #prefixIconSearch>
          <i nz-icon nzType="icons:icon-search"></i>
        </ng-template>
        <nz-select
          class="nz-select-40 rounded filter"
          nzMode="multiple"
          nzAllowClear
          [nzMaxTagCount]="1"
          [nzMaxTagPlaceholder]="tagPlaceHolder"
          [(ngModel)]="featureFlagFilter.tags"
          (ngModelChange)="onSearch(true)"
          i18n-nzPlaceHolder="@@ff.idx.filter-by-tags"
          nzPlaceHolder="Filter by tags">
          @if (isLoadingTags) {
            <nz-option nzDisabled nzCustomContent>
              <i nz-icon nzType="loading" class="loading-icon"></i>
              <ng-container i18n="@@common.loading">Loading...</ng-container>
            </nz-option>
          } @else {
            @for (tag of allTags; track tag) {
              <nz-option [nzValue]="tag" [nzLabel]="tag"></nz-option>
            }
          }
          <ng-template #tagPlaceHolder let-selectedList>and {{ selectedList.length }} more</ng-template>
        </nz-select>
        <nz-select class="nz-select-40 rounded filter" nzAllowClear [(ngModel)]="featureFlagFilter.isEnabled" (ngModelChange)="onSearch(true)" i18n-nzPlaceHolder="@@ff.idx.filter-by-status" nzPlaceHolder="Filter by status">
          <nz-option nzValue="true" nzLabel="ON"></nz-option>
          <nz-option nzValue="false" nzLabel="OFF"></nz-option>
        </nz-select>
        <label nz-checkbox [(ngModel)]="featureFlagFilter.isArchived" (ngModelChange)="onSearch(true)" i18n="@@ff.idx.archived">Archived</label>
      </div>
      <div class="table-actions">
        <button nz-button nzType="primary" (click)="openCreationDrawer()">
          <i nz-icon nzType="icons:icon-add"></i>
          <ng-container i18n="@@common.add">Add</ng-container>
        </button>
        <button class="compare-btn" nz-button nzType="primary" [routerLink]="['/feature-flags/compare']">
          <i nz-icon nzType="swap"></i>
          <span i18n="@@common.compare">Compare</span>
        </button>
        <button class="more-action" nz-dropdown [nzDropdownMenu]="menu" >
          <i nz-icon nzType="icons:icon-menu"></i>
        </button>
        <nz-dropdown-menu #menu="nzDropdownMenu">
          <ul nz-menu>
            <li nz-menu-item (click)="batchCopy()" i18n="@@ff.idx.batch-copy-to">Batch Copy To</li>
          </ul>
        </nz-dropdown-menu>
      </div>
    </div>

    <div class="table-wrapper">
      <nz-table
        #table
        nzSize="small"
        nzShowSizeChanger
        [nzData]="featureFlagListModel.items"
        [nzFrontPagination]="false"
        [nzLoading]="loading"
        [nzTotal]="featureFlagListModel.totalCount"
        [(nzPageSize)]="featureFlagFilter.pageSize"
        (nzPageSizeChange)="onSearch()"
        [nzPageSizeOptions]="[10,20,30]"
        [(nzPageIndex)]="featureFlagFilter.pageIndex"
        (nzPageIndexChange)="onSearch()"
        (nzCurrentPageDataChange)="onCurrentPageDataChange($event)">
        <thead>
          <tr>
            <th [nzChecked]="allChecked" [nzIndeterminate]="indeterminate" (nzCheckedChange)="onAllChecked($event)"></th>
            <th i18n="@@common.name">Name</th>
            <th i18n="@@common.status">Status</th>
            <th i18n="@@common.tags">Tags</th>
            <th i18n="@@common.last-change">Last Change</th>
            <th i18n="@@common.actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (flag of table.data; track flag) {
            <tr>
              <td
                [nzChecked]="itemChecked(flag)"
                (nzCheckedChange)="onItemChecked(flag)"
              ></td>
              <!-- Name Column: name, key-->
              <td class="name-cell">
                <div class="flag-name" [routerLink]="[flag.key, 'targeting']">{{flag.name}}</div>
                <div class="flag-key" (click)="copyText($event, flag.key)">
                  {{flag.key}}
                  <i class="copy-icon" nz-icon nzType="icons:icon-copy"></i>
                </div>
                @if (flag.creator) {
                  <div class="flag-meta">
                    <span i18n="@@common.created-by">Created by</span>
                    <span class="creator-name">{{flag.creator.name || flag.creator.email}}</span>
                    @if (flag.createdAt) {
                      <span class="created-at">{{getLocalDate(flag.createdAt) | date: 'MMM d, yyyy'}}</span>
                    }
                  </div>
                }
              </td>
              <!-- Status Column: on/off switch + serves variations -->
              <td class="status-cell">
                <div class="status-container">
                  <div class="status-row">
                    @if (flag.isEnabled) {
                      <nz-switch
                        i18n-nz-popconfirm="@@ff.are-you-sure-to-turn-ff-off"
                        nz-popconfirm="Are you sure to turn it off? The flag will return the variation that you specified for its off state."
                        (nzOnConfirm)="onToggleFeatureFlagStatus(flag)"
                        nzControl="true"
                        [ngModel]="flag.isEnabled"
                        [nzLoading]="flag.isToggling"
                        nzCheckedChildren="ON"
                        nzUnCheckedChildren="OFF">
                      </nz-switch>
                    } @else {
                      <nz-switch
                        i18n-nz-popconfirm="@@ff.are-you-sure-to-turn-ff-on"
                        nz-popconfirm="Are you sure to turn it on? The flag will return the matching targeting users' or rules' serving variation."
                        (nzOnConfirm)="onToggleFeatureFlagStatus(flag)"
                        nzControl="true"
                        [ngModel]="flag.isEnabled"
                        [nzLoading]="flag.isToggling"
                        nzCheckedChildren="ON"
                        nzUnCheckedChildren="OFF">
                      </nz-switch>
                    }
                    <span class="variation-type-badge" [attr.data-type]="flag.variationType">{{flag.variationType}}</span>
                  </div>
                  <div class="serving-section" [class.disabled]="!flag.isEnabled">
                    @if (flag.isEnabled && flag.serves?.enabledVariations?.length === 1) {
                      <div class="serving-row">
                        <span class="serving-label" i18n="@@ff.serving-variations">Serving: </span>
                        <div class="serving-value" nz-tooltip="{{flag.serves.enabledVariations[0]}}">
                          <span class="variation-tip tip-0"></span>
                          <span class="value-text">{{ flag.serves.enabledVariations[0] }}</span>
                        </div>
                      </div>
                    }
                    @if (flag.isEnabled && flag.serves?.enabledVariations?.length > 1) {
                      <div class="serving-row">
                        <span class="serving-label" i18n="@@ff.serving-variations">Serving: </span>
                        <div class="serving-value multiple" nz-tooltip [nzTooltipTitle]="variationsList">
                          <div class="dots-group">
                            @for (_ of flag.serves?.enabledVariations; track $index; let key = $index) {
                              <span class="variation-tip {{'tip-' + key % 9}}"></span>
                            }
                          </div>
                          <span class="value-text">{{ flag.serves?.enabledVariations?.length }} <ng-container i18n="@@common.num-variations">Variations</ng-container></span>
                          <ng-template #variationsList>
                            <ul>
                              @for (variation of flag.serves?.enabledVariations; track $index) {
                                <li>{{ variation }}</li>
                              }
                            </ul>
                          </ng-template>
                        </div>
                      </div>
                    }
                    @if (!flag.isEnabled) {
                      <div class="serving-row">
                        <span class="serving-label" i18n="@@ff.serving-variations">Serving: </span>
                        <div class="serving-value" nz-tooltip="{{flag.serves?.disabledVariation}}">
                          <span class="variation-tip tip-disabled"></span>
                          <span class="value-text">{{ flag.serves?.disabledVariation }}</span>
                        </div>
                      </div>
                    }
                  </div>
                </div>
              </td>
              <!-- Tags Column -->
              <td class="tags-cell">
                @for (tag of flag.tags; track tag) {
                  <span class="tag" nz-tooltip [nzTooltipTitle]="tag">{{tag}}</span>
                }
              </td>
              <!-- Last Change Column -->
              <td class="last-change-cell">
                @if (flag.lastChange) {
                  <div class="last-change-info">
                    <div class="change-time">{{getLocalDate(flag.lastChange.happenedAt) | date: 'MMM d, yyyy HH:mm'}}</div>
                    @if (flag.lastChange.operator) {
                      <div class="updated-by">
                        <span i18n="@@common.updated-by">Updated by</span>
                        <span class="user">{{flag.lastChange.operator.name || flag.lastChange.operator.email}}</span>
                      </div>
                    }
                    @if (flag.lastChange.comment) {
                      <div class="change-comment" nz-tooltip [nzTooltipTitle]="flag.lastChange.comment">
                        {{flag.lastChange.comment}}
                      </div>
                    }
                  </div>
                } @else {
                  <div class="last-change-info">
                    <span class="no-changes" i18n="@@ff.no-changes-since-creation">No changes since creation</span>
                  </div>
                }
              </td>
              <!-- Actions Column -->
              <td class="actions-cell">
                <a class="action-link primary" [routerLink]="[flag.key, 'targeting']" i18n="@@common.details">Details</a>
                <nz-divider nzType="vertical"></nz-divider>
                <a class="action-link primary" (click)="copy(flag)" i18n="@@common.copy-to">Copy To</a>
                <nz-divider nzType="vertical"></nz-divider>
                <a class="action-link primary" (click)="clone(flag)" i18n="@@common.clone">Clone</a>
                <nz-divider nzType="vertical"></nz-divider>
                <a class="action-link primary" (click)="compare(flag)" i18n="@@common.compare">Compare</a>
                <nz-divider nzType="vertical"></nz-divider>
                @if (isArchived) {
                  <a class="action-link secondary"
                    i18n-nz-popconfirm="@@ff.are-you-sure-to-restore-ff"
                    nz-popconfirm="Are you sure to restore this feature flag?"
                    (nzOnConfirm)="restore(flag)">
                    <ng-container i18n="@@common.restore">Restore</ng-container>
                  </a>
                  <nz-divider nzType="vertical"></nz-divider>
                  <a class="action-link danger"
                    i18n-nz-popconfirm="@@common.remove-confirm"
                    nz-popconfirm="This operation cannot be reverted, are you sure to remove it?"
                    (nzOnConfirm)="delete(flag)">
                    <ng-container i18n="@@common.remove">Remove</ng-container>
                  </a>
                } @else {
                  <a class="action-link secondary" i18n="@@common.archive" (click)="archive(flag)">Archive</a>
                }
              </td>
            </tr>
          }
        </tbody>
      </nz-table>
    </div>
  </div>
</section>

<feature-flag-drawer [visible]="creationDrawerVisible" (onClose)="closeCreationDrawer()"></feature-flag-drawer>
<copy-feature-flag-modal
  [flags]="copyItems"
  [visible]="copyVisible"
  (close)="copyVisible = false">
</copy-feature-flag-modal>
<clone-feature-flag-modal
  [flag]="flagToClone"
  (close)="cloneModalClosed($event)"
  [visible]="cloneVisible">
</clone-feature-flag-modal>
<compare-feature-flag-drawer
  [flag]="flagToCompare"
  [visible]="compareVisible"
  (close)="compareVisible = false">
</compare-feature-flag-drawer>
