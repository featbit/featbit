<section class="body-container">
  <div class="table-content-area">
    <div class="table-search-area">
      <div class="search-inputs">
        <nz-input-group class="query" [nzPrefix]="prefixIconSearch">
          <input nz-input type="text" placeholder="按属性查找" [(ngModel)]="filter.searchText" (ngModelChange)="onSearch(true)">
        </nz-input-group>
        <ng-template #prefixIconSearch>
          <i nz-icon nzType="icons:icon-search"></i>
        </ng-template>
        <nz-select class="filter-multi-select"
                   nzMode="multiple"
                   nzPlaceHolder="选择要搜索的属性"
                   [nzMaxTagCount]="1"
                   [nzMaxTagPlaceholder]="omittedPlaceHolderFilter"
                   [nzCustomTemplate]="multipleTemplate"
                   [(ngModel)]="filter.properties"
                   (ngModelChange)="storeFilterAndAttribute(true)"
                   (nzOnSearch)="onSearchUserProperties($event)">
          <ng-container *ngFor="let item of filteredProps">
            <nz-option *ngIf="!isUserPropsLoading" nzCustomContent [nzValue]="item" [nzLabel]="item">{{item}}</nz-option>
          </ng-container>
          <nz-option *ngIf="isUserPropsLoading" nzDisabled nzCustomContent>
            <i nz-icon nzType="loading" class="loading-icon"></i> 数据加载中...
          </nz-option>

          <ng-template #omittedPlaceHolderFilter>
            <div class="ant-select-selection-item-content"
                 nz-popover="所有选项" [nzPopoverContent]="allSelectedItems" nzPopoverOverlayClassName="selected-items-popover">
            <span class="more-select-selection-item">
              等共 {{ filter.properties.length }} 项
              <i nz-icon nzType="expand"></i>
            </span>
              <ng-template #allSelectedItems>
                <div class="more-select-items">
                  <span class="more-select-item-content" *ngFor="let prop of filter.properties">
                    <span class="more-select-item-content-text" [nz-tooltip]="prop">{{ prop }}</span>
                    <i (click)="onRemoveFilterItem(prop)" nz-icon nzType="close"></i>
                  </span>
                </div>
              </ng-template>
            </div>
          </ng-template>
        </nz-select>
        <nz-select class="attribute-multi-select"
                   nzMode="multiple"
                   nzPlaceHolder="选择要在表格中额外显示的列"
                   [nzMaxTagCount]="1"
                   [nzMaxTagPlaceholder]="omittedPlaceHolderAttribute"
                   [nzCustomTemplate]="multipleTemplate"
                   [(ngModel)]="extraColumns"
                   (ngModelChange)="storeFilterAndAttribute()"
                   (nzOnSearch)="onSearchExtraColumns($event)">
          <ng-container *ngFor="let item of filteredExtraColumns | extraUserColumn: builtInUserProps">
            <nz-option *ngIf="!isUserPropsLoading" nzCustomContent [nzValue]="item" [nzLabel]="item">{{item}}</nz-option>
          </ng-container>
          <nz-option *ngIf="isUserPropsLoading" nzDisabled nzCustomContent>
            <i nz-icon nzType="loading" class="loading-icon"></i> 数据加载中...
          </nz-option>

          <ng-template #omittedPlaceHolderAttribute>
            <div class="ant-select-selection-item-content"
                 nz-popover="所有选项" [nzPopoverContent]="allSelectedItems" nzPopoverOverlayClassName="selected-items-popover">
            <span class="more-select-selection-item">
              等共 {{ extraColumns.length }} 项
              <i nz-icon nzType="expand"></i>
            </span>
              <ng-template #allSelectedItems>
                <div class="more-select-items">
                  <span class="more-select-item-content" *ngFor="let prop of extraColumns">
                    <span class="more-select-item-content-text" [nz-tooltip]="prop">{{ prop }}</span>
                    <i (click)="onRemoveAttributeItem(prop)" nz-icon nzType="close"></i>
                  </span>
                </div>
              </ng-template>
            </div>
          </ng-template>
        </nz-select>

        <ng-template #multipleTemplate let-selected>
          <div class="ant-select-selection-item-content">
            {{ selected.nzLabel }}
          </div>
        </ng-template>

      </div>
      <button nz-button nzType="primary" (click)="onPropsSettingClick()">
        <i nz-icon nzType="icons:icon-setting"></i>
        属性管理
      </button>
    </div>
    <div class="table-wrapper">
      <nz-table #basicTable nzSize="small"
        nzShowSizeChanger
        [nzData]="list"
        [nzFrontPagination]="false"
        [nzLoading]="isLoading"
        [nzTotal]="totalCount"
        [(nzPageSize)]="filter.pageSize"
        (nzPageSizeChange)="onSearch()"
        [nzPageSizeOptions]="[10,20,30]"
        (nzPageIndexChange)="onSearch()"
        [(nzPageIndex)]="filter.pageIndex">
        <thead>
            <tr>
              <th>名称</th>
              <th>KeyId</th>
              <th>Email</th>
              <th *ngFor="let prop of extraColumns | extraUserColumn: builtInUserProps">{{prop}}</th>
              <th>操作</th>
            </tr>
        </thead>
        <tbody style="width: calc(100% - 200px);">
          <ng-container *ngFor="let user of basicTable.data">
            <tr>
              <td>
                <span nz-tooltip="点击进入详情页" (click)="navigateToUserDetail(user)">{{ user.name }}</span>
              </td>
              <td>{{ user.keyId }}</td>
              <td>{{ user.email }}</td>
              <td *ngFor="let prop of extraColumns | extraUserColumn: builtInUserProps">{{getCustomizePropertyValue(user, prop)}}</td>
              <td>
                <a class="primary-link-btn" (click)="onSegmentsAndFlagsClick(user)">
                  开关和用户组
                </a>
                <nz-divider nzType="vertical"></nz-divider>
                <a class="primary-link-btn" nz-button nzType="link" (click)="navigateToUserDetail(user)">详情</a>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </nz-table>
    </div>
  </div>
</section>
<app-props-drawer [visible]="attributeManagevisible" [envId]="currentEnvId" (close)="onPropsSettingClose()"></app-props-drawer>
<user-segments-flags-drawer [visible]="segmentsAndFlagsVisible" [user]="currentUser" [envId]="currentEnvId" (close)="onSegmentsAndFlagsClose()"></user-segments-flags-drawer>
